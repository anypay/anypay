/**
 * Copyright 2019 Yours Inc.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is furnished
 * to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
 * INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
 * PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
 * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
var moneyButton=function(e){"use strict";function t(e,t){return t.encode?t.strict?encodeURIComponent(e).replace(/[!'()*]/g,e=>"%".concat(e.charCodeAt(0).toString(16).toUpperCase())):encodeURIComponent(e):e}var n=(e,n)=>{if(!e)return"";const o=function(e){switch(e.arrayFormat){case"index":return n=>(o,r)=>{const s=o.length;return void 0===r||e.skipNull&&null===r?o:null===r?[...o,[t(n,e),"[",s,"]"].join("")]:[...o,[t(n,e),"[",t(s,e),"]=",t(r,e)].join("")]};case"bracket":return n=>(o,r)=>void 0===r||e.skipNull&&null===r?o:null===r?[...o,[t(n,e),"[]"].join("")]:[...o,[t(n,e),"[]=",t(r,e)].join("")];case"comma":return n=>(o,r)=>null==r||0===r.length?o:0===o.length?[[t(n,e),"=",t(r,e)].join("")]:[[o,t(r,e)].join(",")];default:return n=>(o,r)=>void 0===r||e.skipNull&&null===r?o:null===r?[...o,t(n,e)]:[...o,[t(n,e),"=",t(r,e)].join("")]}}(n=Object.assign({encode:!0,strict:!0,arrayFormat:"none"},n)),r=Object.assign({},e);if(n.skipNull)for(const e of Object.keys(r))void 0!==r[e]&&null!==r[e]||delete r[e];const s=Object.keys(r);return!1!==n.sort&&s.sort(n.sort),s.map(r=>{const s=e[r];return void 0===s?"":null===s?t(r,n):Array.isArray(s)?s.reduce(o(r),[]).join("&"):t(r,n)+"="+t(s,n)}).filter(e=>e.length>0).join("&")};function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(n,!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(n).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},s=Object.keys(e);for(o=0;o<s.length;o++)n=s[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(o=0;o<s.length;o++)n=s[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}function a(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var o=n.call(e,t||"default");if("object"!=typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}class c{constructor(e){this.keyDefined=t=>t in e,this.getValue=t=>e[t]}get(e){if(this.keyDefined(e))return this.getValue(e);throw new Error("Unknown configuration: ".concat(e))}}const u=(new class{constructor(){this.variables={}}build(){return new c(this.variables)}addValue(e,t){if(void 0===t)throw new Error('Failed to add "'.concat(e,'" property. The value cannot be undefined'));if(e in this.variables)throw new Error('"'.concat(e,'" already has a value defined.'));return this.variables[e]=t,this}addValueWithDefault(e,t,n){if(void 0===n)throw new Error('Failed to add "'.concat(e,'" property. Default value cannot be undefined'));return this.addValue(e,void 0===t?n:t)}}).addValue("NETWORK","mainnet").addValue("MONEY_BUTTON_WEBAPP_PROXY_URI","https://www.moneybutton.com").build().get("MONEY_BUTTON_WEBAPP_PROXY_URI");class l{constructor(e){o(this,"start",()=>{window.addEventListener("message",this._onMessageReceived,!1)}),o(this,"enableDeliver",()=>{this._deliverMessages=!0,this._pendingMessages.forEach(e=>this.targetWindow.postMessage(e,"*")),this._pendingMessages=[]}),o(this,"finalize",()=>{window.removeEventListener("message",this._onMessageReceived,!1)}),o(this,"subscribe",(e,t)=>{this.handlers[e]=t}),o(this,"_onMessageReceived",async e=>{if(e.source!==this.targetWindow)return;if(!e.data||!e.data.v1)return;const t=e.data.v1;if(t.repliesTo){const e=this._replayQueue,n=t.repliesTo,{[n]:{resolve:o,reject:r}}=e,s=i(e,[n].map(a));return this._replayQueue=s,void(t.errorResponse?await r(t.payload,t.topic,t.messageId):await o(t.payload,t.topic,t.messageId))}const n=this.handlers[t.topic];if(n)try{const e=await n(t.payload,t.topic,t.messageId);t.reply&&this.send("".concat(t.topic,":reply"),e,{repliesTo:t.messageId,errorResponse:!1})}catch(e){console.error(e),t.reply&&this.send("".concat(t.topic,":reply"),{message:e.message},{repliesTo:t.messageId,errorResponse:!0})}}),o(this,"send",(e,t,n={})=>{const o={v1:s({topic:e,payload:t,messageId:Math.floor(1e17*Math.random()).toString()},n)};return this._deliverMessages?this.targetWindow.postMessage(o,"*"):this._pendingMessages=[...this._pendingMessages,o],o}),o(this,"sendWithReply",async(e,t)=>new Promise((n,o)=>{const{v1:{messageId:r}}=this.send(e,t,{reply:!0});this._replayQueue=s({},this._replayQueue,{[r]:{resolve:n,reject:o}})})),o(this,"sendInsufficientBalanceError",()=>{const e={error:"insufficient balance",popup:{title:"Low balance",message:"Your balance is too low to make this payment.",buttonText:"Add Money",buttonUrl:"".concat(u,"/money")}};this.send("error.insufficient-balance",e)}),o(this,"sendUnexpectedError",e=>{const t={error:"unexpected error",popup:{title:"Unexpected Error",message:e.message}};this.send("error.unexpected-error",t)}),o(this,"sendCryptoOperationsError",e=>{const t={error:"crypto operations error",popup:{title:"Crypto Operations error",message:e.message}};this.send("error.crypto-operations-error",t)}),o(this,"sendPaymentSuccess",e=>{const t={payment:e};this.send("payment-success",t)}),o(this,"sendCryptoOperationsSuccess",e=>{const t={cryptoOperations:e};this.send("crypto-operations-success",t)}),o(this,"sendNotLoggedInError",e=>{const t={error:"not logged in",popup:{title:"Money Button",message:"Money Button is a simple payment system. Join Money Button to make this payment.",buttonText:"Sign up",buttonUrl:"".concat(u,"/register"),buttonText2:"Log in",buttonUrl2:"".concat(u,"/login")}};this.send("error.not-logged-in",t)}),o(this,"sendCompatibilityIssue",e=>{const t={error:"compatibility",message:e.message,popup:{title:"Compatibility",message:e.message}};this.send("error.compatibility",t)}),o(this,"sendSafaryIssueHint",()=>{this.send("error.safari-compatibility",{error:"safari privacy",popup:{title:"Money Button",message:"Money Button is a simple payment system. Enable Money Button on Safari and log in to make this payment.",buttonUrl:"https://blog.moneybutton.com/2018/09/24/how-to-enable-money-button-on-safari-and-ios/",buttonText:"Enable"}})}),this.handlers={},this.targetWindow=e,this._pendingMessages=[],this._deliverMessages=!1,this._replayQueue={}}}let p=null;function d(){p&&(p.parentNode.removeChild(p),p=null)}function m({title:e,message:t,buttonText:n,buttonUrl:o,buttonText2:r,buttonUrl2:s}){d(),p=document.createElement("div"),p.setAttribute("style","display: flex; justify-content: center; font-family: sans-serif;");let i=document.getElementsByClassName("popup__moneybutton").item(0);null===i&&(i=function(){const e=document.createElement("div");return e.className="popup__moneybutton",e.style.position="relative",e.style.display="flex",e.style.justifyContent="center",e}(),document.body.appendChild(i)),i.appendChild(p),p.innerHTML='\n    <div class="close__moneybutton"></div>\n    <div class="hint__moneybutton">\n      <div class="content__moneybutton">\n        <span class="title__moneybutton">'.concat(e,'</span>\n        <span class="text__moneybutton">').concat(t,'</span>\n        <div class="buttonsWrapper__moneybutton">\n          ').concat(n?'<a href="'.concat(o,'" target="_blank" rel="noopener noreferrer" class="button__moneybutton red__moneybutton">').concat(n,"</a>"):"","\n          ").concat(r?'<a href="'.concat(s,'" target="_blank" rel="noopener noreferrer" class="button__moneybutton nofill__moneybutton">').concat(r,"</a>"):"","\n        </div>\n      </div>\n      <style>\n        .hint__moneybutton .button__moneybutton,\n        .hint__moneybutton .title__moneybutton{\n          font-weight:700\n        }\n        .hint__moneybutton .button__moneybutton,\n        .hint__moneybutton .content__moneybutton{\n            color:#fff;\n            box-sizing:border-box;\n            display:flex;\n            font-family: 'IBM Plex Sans', sans-serif;\n        }\n        .hint__moneybutton a{\n            text-decoration:none;\n        }\n        .hint__moneybutton{\n            min-width:254px;\n            position:fixed;\n            bottom: 10px;\n            right: 10px;\n            max-width: 300px;\n            z-index: 1000;\n        }\n        .hint__moneybutton .content__moneybutton{\n          top:0;\n          left:0;\n          right:0;\n          bottom:0;\n          z-index:1\n        }\n        .hint__moneybutton .content__moneybutton{\n            background-color:#191927;\n            padding:30px;\n            border-radius:10px;\n            bottom:19px;\n            left:0;\n            right:0;\n            flex-direction:column;\n            align-content:center;\n            align-items:flex-start;\n            min-width: 260px;\n        }\n        .hint__moneybutton .title__moneybutton{\n            font-size:20px;\n            margin-bottom:10px\n        }\n        .hint__moneybutton .text__moneybutton{\n            font-size:14px;\n            margin-bottom:20px\n        }\n        .hint__moneybutton .buttonsWrapper__moneybutton{\n            width:100%;\n            display:flex;\n            justify-content:space-between;\n            position:relative;\n            z-index:2\n        }\n        .hint__moneybutton .button__moneybutton{\n            text-align:center;\n            font-size:12px;\n            width:calc(50% - 10px);\n            height:35px;\n            padding:0 10px;\n            border-radius:20px;\n            align-items:center;\n            justify-content:center;\n            transition:all 250ms ease-out;\n            cursor:pointer\n        }\n        .hint__moneybutton .button__moneybutton.add__moneybutton {\n            width: auto;\n        }\n        .hint__moneybutton .button__moneybutton.red__moneybutton{\n            background-color:#e54d3f\n        }\n        .hint__moneybutton .button__moneybutton.red__moneybutton:hover{\n            background-color:#ce4134\n        }\n        .hint__moneybutton .button__moneybutton.nofill__moneybutton{\n            border:1px solid #fff\n        }\n        .hint__moneybutton .button__moneybutton.nofill__moneybutton:hover{\n            color:#191927;\n            background-color:#fff\n        }\n        .close__moneybutton {\n          background-color: rgba(255, 255, 255, 0.6);\n          position: fixed;\n          top: 0;\n          left: 0;\n          width: 100vw;\n          height: 100vh;\n          z-index: 999;\n        }\n        @import url('https://fonts.googleapis.com/css?family=IBM+Plex+Sans:400,700');\n      </style>\n    </div>\n  "),document.getElementsByClassName("close__moneybutton").item(0).addEventListener("click",d)}function b(){const e=function(){const e=document.createElement("iframe");return e.style.border="none",e.style.width="1px",e.style.height="1px",e.scrolling="no",e.style.position="fixed",e.style.bottom="-1px",e.style.left="-1px",e.src="".concat("https://www.moneybutton.com","/iframe/imb-payments"),e}();return document.body.appendChild(e),e}class y{constructor(e){this.token=e,this.pmClient=null,this.iframe=null,this.resetConnection()}async swipe(e){return document.body.contains(this.iframe)||await this.resetConnection(),await this.pmClient.sendWithReply("imb.start-payment",{authToken:this.token,attributes:e})}async amountLeft(){return document.body.contains(this.iframe)||await this.resetConnection(),await this.pmClient.sendWithReply("imb.amount-left",{authToken:this.token})}async resetConnection(){return new Promise(e=>{this.pmClient&&this.pmClient.finalize(),this.iframe=b(),this.pmClient=new l(this.iframe.contentWindow),this.pmClient.start(),this.iframe.onload=()=>{this.pmClient.enableDeliver(),e()}})}}const h="".concat("https://www.moneybutton.com","/iframe/imb-permission-grant");function f(e){const t=function(){const e=document.createElement("iframe");return e.style.border="none",e.style.width="100vw",e.style.height="100vh",e.scrolling="no",e.src=h,e}();return e.appendChild(t),t.contentWindow.onunload=()=>{null!==t.contentWindow&&t.contentWindow.location.href!==h||(e.innerHTML="")},t}const g=["to","amount","currency","label","successMessage","opReturn","outputs","cryptoOperations","clientIdentifier","buttonId","buttonData","type","onPayment","onError","onLoad","devMode","editable","disabled"],_=new Map;function w(e,t={}){_.has(e)?function(e,t){const n=_.get(e);n.send("attributes-updated",v(t)),n.subscribe("payment-success",e=>O(e,t)),n.subscribe("crypto-operations-success",e=>E(e,t)),n.subscribe("error.insufficient-balance",e=>P(e,t)),n.subscribe("error.unexpected-error",e=>P(e,t)),n.subscribe("error.crypto-operations-error",e=>P(e,t)),n.subscribe("error.not-logged-in",e=>P(e,t)),n.subscribe("error.compatibility",e=>P(e,t)),n.subscribe("error.safari-compatibility",e=>P(e,t)),n.subscribe("error.too-long-mempool-chain",e=>P(e,t)),n.subscribe("error",e=>P(e,t))}(e,t):function(e,t){!function(e,t){if(!(e instanceof Element))throw new Error("The first argument must be of type Element.");if(!(e instanceof Object)||0===Object.keys(t).length)throw new Error("Please, specify the button's attributes.");if(void 0!==t.buttonData&&"string"!=typeof t.buttonData)throw new Error('"buttonData" should be a string.')}(e,t);const n=function(e={}){const t=document.createElement("iframe");return t.style.border="none",t.style.width="280px",t.style.height="50px",t.scrolling="no",t.src=x(),t}(t);e.appendChild(n),e.style.position="relative",e.style.display="inline-block",e.style.width="280px",e.style.height="50px",n.contentWindow.onunload=()=>{null!==n.contentWindow&&n.contentWindow.location.href!==x()||(_.delete(e),e.innerHTML="")};const o=new l(n.contentWindow);o.send("initial-attributes",v(t),{}),o.subscribe("ready",()=>{o.enableDeliver(),t.onLoad&&"function"==typeof t.onLoad&&t.onLoad()}),o.subscribe("payment-success",e=>O(e,t)),o.subscribe("crypto-operations-success",e=>E(e,t)),o.subscribe("error.insufficient-balance",e=>P(e,t)),o.subscribe("error.unexpected-error",e=>P(e,t)),o.subscribe("error.crypto-operations-error",e=>P(e,t)),o.subscribe("error.not-logged-in",e=>P(e,t)),o.subscribe("error.compatibility",e=>P(e,t)),o.subscribe("error.safari-compatibility",e=>P(e,t)),o.subscribe("error.too-long-mempool-chain",e=>P(e,t)),o.subscribe("error",e=>P(e,t)),o.start(),_.set(e,o)}(e,t)}function v(e){return{to:e.to,amt:e.amount,edt:e.editable,ccy:e.currency,lbl:e.label,scsmsg:e.successMessage,opd:e.opReturn,os:JSON.stringify(e.outputs),cid:e.clientIdentifier,bid:e.buttonId,bdt:e.buttonData,t:e.type,dev:e.devMode,dsbd:e.disabled,crop:JSON.stringify(e.cryptoOperations)}}function x(){return"".concat("https://www.moneybutton.com","/iframe/v2?").concat(n({format:"postmessage"}))}function O(e,t){const{payment:n}=e;n&&"function"==typeof t.onPayment&&t.onPayment.call(window,n)}function E(e,t){const{cryptoOperations:n}=e;n&&"function"==typeof t.onCryptoOperations&&t.onCryptoOperations.call(window,n)}function P(e,t){const{error:n,popup:o}=e;o&&m(o),n&&"function"==typeof t.onError&&t.onError.call(window,new Error(n))}function k(e){const t={};for(const n in e){const o=e[n];if(g.includes(n))switch(n){case"outputs":let e;try{e=JSON.parse(o)}catch(t){e=null}e instanceof Array?t[n]=e:console.warn("The value provided for ".concat(n," is not a valid JSON array."));break;case"cryptoOperations":let r;try{r=JSON.parse(o)}catch(e){r=[]}r instanceof Array?t[n]=r:console.warn("cryptoOperations should be an array");break;case"devMode":t[n]="true"===o;break;case"onPayment":case"onError":case"onLoad":"function"==typeof window[o]?t[n]=window[o]:console.warn("The value provided for ".concat(n," is not a function in the global scope."));break;default:t[n]=o}else console.warn("Unexpected data attribute: ".concat(n,"."))}return t}return document.addEventListener("DOMContentLoaded",(function(){if(window.moneyButton.alreadyLoaded)return;window.moneyButton.alreadyLoaded=!0;const e=document.getElementsByClassName("money-button");for(let t=0;t<e.length;++t){const n=e.item(t);try{const e=k(n.dataset);Object.keys(e).length>0&&w(n,e),console.log("Money Button: added button.")}catch(e){console.error("Money Button: adding button failed.",e)}}})),e.IMB=class{constructor(e){this.config=e,e.permission?this.paymentProcessor=new y(e.permission):this.paymentProcessor=null}async swipe(e){return null===this.paymentProcessor&&await this.askForPermission(),this.paymentProcessor.swipe(e)}async getPermission(){return null===this.paymentProcessor&&await this.askForPermission(),this.paymentProcessor.token}async amountLeft(e){if(null===this.paymentProcessor)throw new Error("No active permission.");return this.paymentProcessor.amountLeft(e)}async askForPermission(e){return e={amount:"5",currency:"USD",...this.config,...e},new Promise((t,n)=>{const o=document.createElement("div");o.style.position="fixed",o.style.top="0px",o.style.left="0px",o.style.width="100%",o.style.height="100%",document.body.appendChild(o);const r=f(o),s=new l(r.contentWindow);s.enableDeliver(),s.subscribe("ready",()=>{s.send("imb.request-swipe-permission",{clientIdentifier:this.config.clientIdentifier,amount:e.amount,currency:e.currency})}),s.subscribe("imb.permission-granted",e=>{if(this.paymentProcessor=new y(e.token),"function"==typeof this.config.onNewPermissionGranted)try{this.config.onNewPermissionGranted(e.token)}catch(e){console.error("There was a problem when attempting to save the permission code:",e.message),console.error(e)}s.finalize(),document.body.removeChild(o),function(e){const t=document.createElement("div");t.style.position="absolute",t.style.bottom="20px",t.style.left="50%",t.style.width="400px",t.style.marginLeft="-200px",t.style.backgroundColor="#4772F6",t.style.padding="45px 40px 40px 40px",t.style.boxSizing="border-box",t.style.borderRadius="20px 20px 0 20px",t.innerHTML="\n  <h3 class='imb-success-popup_title__moneybutton'>No more buttons!</h3>\n  <span class='imb-success-popup_text__moneybutton'>\n    You can remove, change or renew your <i>".concat(e,"</i> permission\n    from the settings section inside your\n    <a rel='noopener noreferrer' target='_blank' class='imb-success-popup_link__moneybutton' href='").concat("https://www.moneybutton.com","/settings/apps#myPermissions'>Money Button wallet</a>\n  </span>\n  <style>\n  .imb-success-popup_text__moneybutton, .imb-success-popup_title__moneybutton {\n    font-size: 12px;\n    font-family: 'IBM Plex Sans', sans-serif;\n    color: white;\n  }\n\n  .imb-success-popup_text__moneybutton {\n    font-weight: 500;\n  }\n\n  .imb-success-popup_title__moneybutton {\n    font-size: 18px;\n    margin-top: 0;\n    padding-top: 0;\n  }\n\n  .imb-success-popup_link__moneybutton {\n    color: white;\n    text-decoration: none;\n    font-weight: bold;\n  }\n  </style>\n  "),document.body.appendChild(t),setTimeout(()=>document.body.removeChild(t),4e3)}(e.app.name),t(this)}),s.subscribe("imb.permission-dennied",e=>{s.finalize(),document.body.removeChild(o),n(e)}),s.subscribe("error.not-logged-in",e=>{m(e.popup),s.finalize(),document.body.removeChild(o),n(new Error("no-user-logged-in"))}),s.subscribe("error.insufficient-balance",e=>{m(e.popup)}),s.start()})}},e.render=w,e}({});
